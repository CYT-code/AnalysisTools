<!--
    ğŸ—ï¸ åŸºæ¨è©³ç´°é¸æ¨åˆ†æç³»çµ±
    Copyright (c) 2025
    
    ä¿ç•™æ‰€æœ‰æ¬Šåˆ© (All Rights Reserved)ã€‚
    
    æˆæ¬Šèªªæ˜ï¼š
    æœ¬ç¨‹å¼ç¢¼åŠç›¸é—œä»‹é¢è¨­è¨ˆåƒ…ä¾› [æˆæ¬Šå–®ä½/å°ˆæ¡ˆ] å…§éƒ¨ä½¿ç”¨ã€‚
    æœªç¶“è‘—ä½œæ¬Šäººæ›¸é¢è¨±å¯ï¼Œä¸å¾—ä»¥ä»»ä½•å½¢å¼è¤‡è£½ã€ä¿®æ”¹ã€åˆ†ç™¼æˆ–å…¬é–‹å±•ç¤ºæœ¬è»Ÿé«”ã€‚
    æœ¬è»Ÿé«”æŒ‰ã€ŒåŸæ¨£ã€æä¾›ï¼Œä¸æä¾›ä»»ä½•æ˜ç¤ºæˆ–æš—ç¤ºçš„ä¿è­‰ï¼ŒåŒ…æ‹¬ä½†ä¸é™æ–¼é©éŠ·æ€§ã€ç‰¹å®šç”¨é€”é©ç”¨æ€§å’Œä¸ä¾µæ¬Šçš„ä¿è­‰ã€‚
-->
<!DOCTYPE html>
<html lang="zh-TW">
<script>
  // è¨­å®šæ­£ç¢ºå¯†ç¢¼
  var correctPassword = "80649660"; 

  // è·³å‡ºè¦–çª—
  var input = prompt("ã€ä¿¡æ¥­å·¥ç¨‹é¡§å•è‚¡ä»½æœ‰é™å…¬å¸ çµæ§‹è¨­è¨ˆéƒ¨å°ˆç”¨å·¥å…·ã€‘\n\nâš ï¸ å…§éƒ¨ä½¿ç”¨è«‹å‹¿å¤–æµ âš ï¸\nè«‹è¼¸å…¥ä½¿ç”¨å¯†ç¢¼ä»¥ç¹¼çºŒï¼š");

  // åˆ¤æ–·é‚è¼¯ï¼šå¦‚æœè¼¸å…¥çš„å¯†ç¢¼ ä¸ç­‰æ–¼ æ­£ç¢ºå¯†ç¢¼ (æˆ–æ˜¯æŒ‰äº†å–æ¶ˆ)
  if (input !== correctPassword) {
    // 1. å¼·åˆ¶ç”¨é€™æ®µæ–‡å­—è¦†è“‹æ‰æ•´å€‹ç¶²é 
    document.write('<div style="display:flex;justify-content:center;align-items:center;height:100vh;"><h1>ğŸš« å¯†ç¢¼éŒ¯èª¤æˆ–éæœ¬å…¬å¸äººå“¡ï¼Œç¦æ­¢å­˜å–</h1></div>');
    
    // 2. å‘½ä»¤ç€è¦½å™¨ç«‹åˆ»åœæ­¢è¼‰å…¥å‰©ä¸‹çš„ HTML
    window.stop();
    
    // 3. æ‹‹å‡ºä¸€å€‹éŒ¯èª¤ä¾†ç¢ºä¿ä¸‹æ–¹çš„ç¨‹å¼ç¢¼çµ•å°ä¸æœƒåŸ·è¡Œ (ä¿éšªèµ·è¦‹)
    throw new Error("Access Denied");
  }
</script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºæ¨é¸æ¨åˆ†æç³»çµ± (æ–‡å­—è²¼ä¸Šç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .modal-open { overflow: hidden; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body p { margin-bottom: 1em; }
        
        /* Loading Animation */
        .sparkle-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        textarea {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: scroll;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 flex flex-col">

    <!-- Top Bar for API Key -->
    <div class="bg-indigo-900 text-white py-3 px-4 shadow-md flex-none">
        <div class="max-w-[95%] mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center space-x-2">
                <span class="text-xl">âœ¨</span>
                <span class="font-bold tracking-wide">AI æ™ºæ…§æ¨¡çµ„</span>
            </div>
            <div class="flex items-center space-x-3 w-full md:w-auto">
                <label for="api-key-input" class="text-sm text-indigo-200 whitespace-nowrap">Gemini API Key:</label>
                <input type="password" id="api-key-input" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API Key" class="px-3 py-1 text-slate-800 rounded text-sm w-full md:w-64 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-indigo-300 hover:text-white underline whitespace-nowrap">å–å¾— Key</a>
            </div>
        </div>
    </div>

    <div class="flex-grow max-w-[95%] mx-auto px-4 py-8 w-full">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">ğŸ—ï¸ åŸºæ¨è©³ç´°é¸æ¨åˆ†æç³»çµ± <span class="text-indigo-600 text-lg align-top bg-indigo-50 px-2 py-0.5 rounded-full border border-indigo-200">AI Powered</span></h1>
            <p class="text-slate-600">ç›´æ¥è²¼ä¸Š Excel æ•¸æ“šï¼Œé‡å° P(æ‰¿å£“) èˆ‡ T(æ‹‰æ‹”) é€²è¡Œå®‰å…¨ä¿‚æ•¸æª¢æ ¸</p>
        </header>

        <!-- Logic Explanation -->
        <div class="bg-amber-50 border-l-4 border-amber-500 p-4 mb-8 rounded shadow-sm">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-amber-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3 w-full">
                    <h3 class="text-sm font-bold text-amber-800 uppercase tracking-wide">æª¢æŸ¥é‚è¼¯èˆ‡æ–°æ ¼å¼èªªæ˜</h3>
                    <div class="mt-2 text-sm text-amber-900 grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <ul class="list-disc pl-5 space-y-1">
                            <li><strong>æ‰¿å£“åŠ› P</strong>ï¼šå®¹è¨±å€¼ â‰§ (åˆ†æå€¼ Ã— SF)</li>
                            <li><strong>æ‹‰æ‹”åŠ› T</strong>ï¼š(å®¹è¨±å€¼ Ã— -1) â‰¦ (åˆ†æå€¼ Ã— SF)</li>
                        </ul>
                        <div class="text-xs text-amber-700 bg-amber-100 p-2 rounded">
                            <p><strong>å®¹è¨±å€¼æ ¼å¼ (8æ¬„):</strong> åŸºæ¨å°ºå¯¸ | æ·±åº¦ | P(é•·) | P(çŸ­) | P(æ¥µ) | T(é•·) | T(çŸ­) | T(æ¥µ)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Analysis Input -->
            <div class="bg-white p-4 rounded-lg shadow border border-slate-200 flex flex-col h-[500px]">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-bold flex items-center text-blue-700">
                        <span class="bg-blue-100 text-blue-700 py-1 px-2 rounded text-sm mr-2">1</span>
                        è²¼ä¸Š åˆ†æçµæœæ•¸æ“š
                    </h2>
                    <button onclick="clearAnalysis()" class="text-xs text-slate-400 hover:text-red-500 underline">æ¸…ç©º</button>
                </div>
                <div class="flex-grow relative">
                    <textarea id="input-analysis" class="w-full h-full p-4 border border-slate-300 rounded focus:ring-2 focus:ring-blue-400 focus:border-transparent text-xs leading-relaxed resize-none" placeholder="è«‹å¾ Excel è¤‡è£½æ•¸æ“šä¸¦è²¼ä¸Š (ä¸å«æ¨™é¡Œåˆ—)&#10;æ ¼å¼ç¯„ä¾‹:&#10;é»ä½ID  P(é•·)  P(çŸ­)  P(æ¥µ)  T(é•·)  T(çŸ­)  T(æ¥µ)&#10;16      1192   1401   1723   -59    -766   -1088&#10;..."></textarea>
                </div>
                <div class="mt-2 text-xs text-slate-500 flex justify-between">
                    <span>æ¬„ä½é †åº: é»ä½, P(é•·), P(çŸ­), P(æ¥µ), T(é•·), T(çŸ­), T(æ¥µ)</span>
                    <span id="count-analysis" class="font-bold">0 ç­†</span>
                </div>
            </div>

            <!-- Allowable Input -->
            <div class="bg-white p-4 rounded-lg shadow border border-slate-200 flex flex-col h-[500px]">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-bold flex items-center text-emerald-700">
                        <span class="bg-emerald-100 text-emerald-700 py-1 px-2 rounded text-sm mr-2">2</span>
                        è²¼ä¸Š å®¹è¨±å€¼æ•¸æ“š
                    </h2>
                    <button onclick="clearAllowable()" class="text-xs text-slate-400 hover:text-red-500 underline">æ¸…ç©º</button>
                </div>
                <div class="flex-grow relative">
                    <textarea id="input-allowable" class="w-full h-full p-4 border border-slate-300 rounded focus:ring-2 focus:ring-emerald-400 focus:border-transparent text-xs leading-relaxed resize-none" placeholder="è«‹å¾ Excel è¤‡è£½æ•¸æ“šä¸¦è²¼ä¸Š (ä¸å«æ¨™é¡Œåˆ—)&#10;æ ¼å¼ç¯„ä¾‹:&#10;å°ºå¯¸     æ·±åº¦  P(é•·)  P(çŸ­)  P(æ¥µ)  T(é•·)  T(çŸ­)  T(æ¥µ)&#10;1.2Ã—2.5  50    3110   4316   5797   573    721    870&#10;..."></textarea>
                </div>
                <div class="mt-2 text-xs text-slate-500 flex justify-between">
                    <span>æ¬„ä½é †åº: å°ºå¯¸, æ·±åº¦, P(é•·), P(çŸ­), P(æ¥µ), T(é•·), T(çŸ­), T(æ¥µ)</span>
                    <span id="count-allowable" class="font-bold">0 ç­†</span>
                </div>
            </div>
        </div>

        <!-- Action & Settings -->
        <div class="flex flex-col items-center justify-center mb-10 space-y-4">
            <!-- Safety Factor Input -->
            <div class="flex items-center space-x-3 bg-white p-4 rounded-lg shadow border border-gray-200">
                <label for="safety-factor" class="font-bold text-gray-700">ğŸ›¡ï¸ å®‰å…¨ä¿‚æ•¸ (Safety Factor):</label>
                <div class="relative">
                    <input type="number" id="safety-factor" value="1.01" step="0.01" min="1.00" class="w-24 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-lg text-center font-bold text-indigo-700">
                </div>
                <span class="text-sm text-gray-400">(é è¨­ 1.01)</span>
            </div>

            <div class="flex space-x-4">
                <button onclick="loadDemoData()" class="bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-full shadow hover:bg-gray-300 transition-all text-sm">
                    è¼‰å…¥ç¯„ä¾‹æ•¸æ“š
                </button>
                <button id="btn-process" class="bg-indigo-600 text-white font-bold py-3 px-10 rounded-full shadow-lg transform transition-all duration-200 hover:bg-indigo-700 hover:scale-105 hover:shadow-xl ring-2 ring-offset-2 ring-transparent focus:ring-indigo-500 flex items-center justify-center">
                    <span>é–‹å§‹æª¢æ ¸</span>
                </button>
            </div>
            <p id="error-msg" class="text-red-600 font-bold text-sm hidden bg-red-50 px-4 py-1 rounded border border-red-200"></p>
        </div>

        <!-- Results -->
        <div id="result-section" class="hidden animate-fade-in-up">
            
            <!-- AI Summary Section -->
            <div class="mb-8 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6 border border-indigo-100 shadow-sm relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-2 -mr-2 w-16 h-16 bg-purple-200 rounded-full blur-xl opacity-50"></div>
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 relative z-10">
                    <div class="flex items-center space-x-2">
                        <div class="bg-indigo-600 text-white p-1.5 rounded-lg shadow-sm">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                        <h3 class="text-lg font-bold text-indigo-900">AI å·¥ç¨‹ç¸½çµå ±å‘Š</h3>
                    </div>
                    <button id="btn-ai-summary" class="mt-2 md:mt-0 bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-50 font-bold py-1.5 px-4 rounded-full text-sm shadow-sm transition-all flex items-center">
                        <span class="mr-1">âœ¨</span> ç”Ÿæˆå ±å‘Š
                    </button>
                </div>
                <div id="ai-summary-content" class="text-slate-600 text-sm leading-relaxed markdown-body">
                    <p class="italic text-slate-400">é»æ“Šã€Œç”Ÿæˆå ±å‘Šã€æŒ‰éˆ•ï¼Œè®“ AI ç‚ºæ‚¨æ’°å¯«æœ¬æ¬¡åŸºæ¨é¸æ¨çš„å·¥ç¨‹ç¸½çµåˆ†æã€‚</p>
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-4 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">åˆ†æçµæœé è¦½ <span id="sf-display" class="text-sm font-normal text-indigo-600 ml-2 bg-indigo-50 px-2 py-1 rounded"></span></h2>
                    <p class="text-sm text-slate-500 mt-1">é è¦½åƒ…é¡¯ç¤ºå‰ 100 ç­†ã€‚å®Œæ•´çµæœè«‹ä¸‹è¼‰ CSVã€‚</p>
                </div>
                <button id="btn-download" class="w-full md:w-auto bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2.5 px-6 rounded shadow-md flex items-center justify-center transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    ä¸‹è¼‰è©³ç´°å ±å‘Š (CSV)
                </button>
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden border border-slate-200">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 text-sm">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-3 text-left font-bold text-slate-600">é»ä½ ID</th>
                                <th class="px-4 py-3 text-left font-bold text-slate-600">P(æ¥µé™) / T(æ¥µé™) (åŸå§‹)</th>
                                <th class="px-4 py-3 text-left font-bold text-slate-600">å»ºè­°æ¨å‹</th>
                                <th class="px-4 py-3 text-center font-bold text-slate-600">ç¬¦åˆæ•¸</th>
                                <th class="px-4 py-3 text-center font-bold text-slate-600">ç‹€æ…‹</th>
                                <th class="px-4 py-3 text-center font-bold text-slate-600">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="result-body" class="bg-white divide-y divide-slate-200">
                            <!-- Rows injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer with License -->
    <footer class="bg-slate-800 text-slate-300 py-6 mt-12 flex-none">
        <div class="max-w-[95%] mx-auto px-4 flex flex-col md:flex-row justify-between items-center text-sm">
            <div class="mb-2 md:mb-0">
                <p>&copy; 2025 åŸºæ¨é¸æ¨åˆ†æç³»çµ±. ä¿ç•™æ‰€æœ‰æ¬Šåˆ© (All Rights Reserved).</p>
                <p class="text-xs text-slate-500 mt-1">åƒ…é™ä¿¡æ¥­å·¥ç¨‹é¡§å•è‚¡ä»½æœ‰é™å…¬å¸å°ˆæ¡ˆä½¿ç”¨ï¼Œç¦æ­¢æœªç¶“æˆæ¬Šä¹‹è¤‡è£½æˆ–åˆ†ç™¼ã€‚</p>
            </div>
            <div>
                <button onclick="showLicense()" class="hover:text-white underline decoration-slate-500 hover:decoration-white transition-colors">
                    æˆæ¬Šæ¢æ¬¾èˆ‡å…è²¬è²æ˜
                </button>
            </div>
        </div>
    </footer>

    <!-- Modal for License -->
    <div id="license-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-[60] p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full flex flex-col animate-scale-in">
            <div class="p-6 border-b border-gray-200 bg-slate-50 rounded-t-lg">
                <h3 class="text-xl font-bold text-slate-800">æˆæ¬Šæ¢æ¬¾èˆ‡å…è²¬è²æ˜</h3>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh] text-sm text-slate-700 space-y-4">
                <div>
                    <h4 class="font-bold text-slate-900 mb-1">1. ä½¿ç”¨æ¬Šé™</h4>
                    <p>æœ¬è»Ÿé«”ï¼ˆä»¥ä¸‹ç°¡ç¨±ã€Œæœ¬ç³»çµ±ã€ï¼‰åƒ…æˆæ¬Šäºˆç‰¹å®šå·¥ç¨‹å°ˆæ¡ˆå…§éƒ¨äººå“¡ä½¿ç”¨ã€‚æœªç¶“è‘—ä½œæ¬Šäººæ˜ç¢ºæ›¸é¢è¨±å¯ï¼Œåš´ç¦å°‡æœ¬ç³»çµ±ç”¨æ–¼å•†æ¥­è½‰å”®ã€å…¬é–‹åˆ†ç™¼æˆ–ä½œç‚ºç¬¬ä¸‰æ–¹æœå‹™çš„ä¸€éƒ¨åˆ†ã€‚</p>
                </div>
                <div>
                    <h4 class="font-bold text-slate-900 mb-1">2. æ™ºæ…§è²¡ç”¢æ¬Š</h4>
                    <p>æœ¬ç³»çµ±ä¹‹ç¨‹å¼ç¢¼ã€è¨­è¨ˆä»‹é¢åŠé‹ç®—é‚è¼¯å‡å—è‘—ä½œæ¬Šæ³•ä¿è­·ã€‚æ‰€æœ‰æ¬Šåˆ©å‡æ­¸é–‹ç™¼è€…æ‰€æœ‰ã€‚</p>
                </div>
                <div>
                    <h4 class="font-bold text-slate-900 mb-1">3. å…è²¬è²æ˜ (é‡è¦)</h4>
                    <p class="bg-red-50 p-3 rounded border-l-4 border-red-500 text-red-800">
                        æœ¬ç³»çµ±åƒ…ä½œç‚ºè¼”åŠ©å·¥ç¨‹é‹ç®—ä¹‹å·¥å…·ã€‚ä½¿ç”¨è€…æ‡‰ç†è§£ï¼Œæ‰€æœ‰è¼¸å‡ºçµæœå¿…é ˆç¶“éå°ˆæ¥­å·¥ç¨‹å¸«çš„è¦†æ ¸èˆ‡é©—è­‰ã€‚é–‹ç™¼è€…ä¸å°å› ä½¿ç”¨æœ¬ç³»çµ±è€Œå°è‡´çš„ä»»ä½•çµæ§‹å®‰å…¨å•é¡Œã€æ•¸æ“šéŒ¯èª¤æˆ–ç¶“æ¿Ÿæå¤±æ‰¿æ“”è²¬ä»»ã€‚
                    </p>
                </div>
                <div>
                    <h4 class="font-bold text-slate-900 mb-1">4. æ•¸æ“šéš±ç§</h4>
                    <p>æœ¬ç³»çµ±ç‚ºç´”å‰ç«¯é‹ä½œï¼Œæ‰€æœ‰æ•¸æ“šåˆ†æçš†åœ¨ä½¿ç”¨è€…ä¹‹ç€è¦½å™¨å…§å®Œæˆï¼Œä¸æœƒä¸Šå‚³è‡³ä»»ä½•å¤–éƒ¨ä¼ºæœå™¨ï¼ˆé™¤ä½¿ç”¨ AI åŠŸèƒ½æ™‚ï¼Œéƒ¨åˆ†æ•¸æ“šæœƒå‚³é€è‡³ Google Gemini APIï¼‰ã€‚</p>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg text-right">
                <button onclick="closeLicense()" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-2 rounded font-bold transition-colors">æˆ‘å·²äº†è§£</button>
            </div>
        </div>
    </div>

    <!-- Modal for Detail View -->
    <div id="detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] flex flex-col animate-scale-in">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-slate-50 rounded-t-lg">
                <h3 class="text-xl font-bold text-slate-800" id="modal-title">é»ä½è©³ç´°æ¯”å°</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="modal-content">
                    <!-- Dynamic Content -->
                </div>
                
                <!-- AI Insight Block inside Modal -->
                <div id="ai-insight-block" class="mt-6 border-t pt-4 hidden">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-indigo-800 flex items-center">
                            <span class="mr-2">âœ¨</span> AI å°ˆå®¶åˆ†æ
                        </h4>
                        <button id="btn-ai-detail" class="text-xs bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-3 py-1 rounded-full font-bold transition-colors">
                            åˆ†ææ­¤é»ä½
                        </button>
                    </div>
                    <div id="ai-detail-result" class="bg-indigo-50 p-3 rounded-lg text-sm text-slate-600 min-h-[60px] markdown-body">
                        <p class="text-slate-400 italic">é»æ“ŠæŒ‰éˆ•ï¼Œè®“ AI åˆ†ææ­¤æ¨ä½çš„æ‡‰åŠ›æ¯”èˆ‡æ§åˆ¶å› å­ã€‚</p>
                    </div>
                </div>

            </div>
            <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg text-right">
                <button onclick="closeModal()" class="bg-slate-600 hover:bg-slate-700 text-white px-6 py-2 rounded">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script>
        // --- Gemini API ---
        let userApiKey = ""; 

        async function callGemini(prompt) {
            const apiKeyInput = document.getElementById('api-key-input').value.trim();
            const apiKey = apiKeyInput || ""; 
            
            if (!apiKey) {
                alert("è«‹å…ˆåœ¨é é¢å³ä¸Šè§’è¼¸å…¥æ‚¨çš„ Gemini API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ï¼");
                return null;
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error((await response.json()).error?.message || "API Request Failed");
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                alert("AI åˆ†æç™¼ç”ŸéŒ¯èª¤: " + error.message);
                return null;
            }
        }

        // --- Data Variables ---
        let analysisData = [];
        let allowableData = [];
        let globalResults = null;
        let currentSF = 1.01;
        let currentDetailIndex = -1;

        // --- Data Parsing Functions ---

        // Helper: Clear inputs
        function clearAnalysis() { document.getElementById('input-analysis').value = ''; updateCounts(); }
        function clearAllowable() { document.getElementById('input-allowable').value = ''; updateCounts(); }

        // Helper: Update counts based on text
        function updateCounts() {
            const anaText = document.getElementById('input-analysis').value;
            const allowText = document.getElementById('input-allowable').value;
            
            const anaCount = anaText.trim() ? anaText.trim().split(/\n/).length : 0;
            const allowCount = allowText.trim() ? allowText.trim().split(/\n/).length : 0;

            document.getElementById('count-analysis').textContent = `${anaCount} ç­†`;
            document.getElementById('count-allowable').textContent = `${allowCount} ç­†`;
        }

        // Add listeners to textareas
        document.getElementById('input-analysis').addEventListener('input', updateCounts);
        document.getElementById('input-allowable').addEventListener('input', updateCounts);

        function parseAnalysis(text) {
            const lines = text.trim().split(/\n/);
            const data = [];
            lines.forEach((line, idx) => {
                if(!line.trim()) return;
                const parts = line.trim().split(/\t+/); // Split by tab or multiple spaces
                // Allow flexible parsing (tab or space)
                const cleanParts = line.trim().split(/[\t\s]+/); 

                if (cleanParts.length < 7) return; 

                // Try to parse numbers. If fail, maybe it's a header line, skip.
                const p1 = parseFloat(cleanParts[1]);
                if (isNaN(p1)) return; // Header detection

                data.push({
                    id: cleanParts[0].trim(),
                    p: { long: parseFloat(cleanParts[1]), short: parseFloat(cleanParts[2]), ult: parseFloat(cleanParts[3]) },
                    t: { long: parseFloat(cleanParts[4]), short: parseFloat(cleanParts[5]), ult: parseFloat(cleanParts[6]) }
                });
            });
            return data;
        }

        function parseAllowable(text) {
            const lines = text.trim().split(/\n/);
            const data = [];
            lines.forEach(line => {
                if(!line.trim()) return;
                const cleanParts = line.trim().split(/[\t\s]+/);
                
                // New Format: Size(0), Depth(1), P_L(2), P_S(3), P_U(4), T_L(5), T_S(6), T_U(7)
                if (cleanParts.length < 8) return;

                const p1 = parseFloat(cleanParts[2]);
                if (isNaN(p1)) return; // Header detection

                data.push({
                    fullDesc: `${cleanParts[0]} (D=${cleanParts[1]}m)`,
                    shortName: cleanParts[0],
                    depth: cleanParts[1],
                    p: { long: parseFloat(cleanParts[2]), short: parseFloat(cleanParts[3]), ult: parseFloat(cleanParts[4]) },
                    t: { long: parseFloat(cleanParts[5]), short: parseFloat(cleanParts[6]), ult: parseFloat(cleanParts[7]) }
                });
            });
            return data;
        }

        // --- Demo Data ---
        function loadDemoData() {
            const demoAnalysis = `16	1192.2	1401.1	1723.7	-59.1	-766.0	-1088.7
17	946.5	844.9	1032.8	-183.8	-558.4	-746.2
18	822.1	638.9	784.5	-239.9	-512.6	-658.1
20	1150.4	760.4	820.6	-9.8	-70.2	-130.4`;

            const demoAllowable = `1.2Ã—2.5	50	3110	4316	5797	573	721	870
1.2Ã—2.5	51	3203	4446	5967	593	747	900
1.2Ã—3	50	3690	5122	6888	659	827	996
1.2Ã—3	51	3800	5274	7089	683	857	1032`;

            document.getElementById('input-analysis').value = demoAnalysis;
            document.getElementById('input-allowable').value = demoAllowable;
            updateCounts();
        }

        // --- Main Process Logic ---
        document.getElementById('btn-process').addEventListener('click', () => {
            const analysisText = document.getElementById('input-analysis').value;
            const allowableText = document.getElementById('input-allowable').value;

            if (!analysisText.trim() || !allowableText.trim()) {
                alert("è«‹å…ˆè²¼ä¸Šã€Œåˆ†æçµæœã€èˆ‡ã€Œå®¹è¨±å€¼ã€æ•¸æ“šï¼");
                return;
            }
            
            // Parse Data
            analysisData = parseAnalysis(analysisText);
            allowableData = parseAllowable(allowableText);

            if (analysisData.length === 0) { alert("åˆ†æçµæœæ•¸æ“šæ ¼å¼éŒ¯èª¤æˆ–ç„¡æœ‰æ•ˆè³‡æ–™ï¼Œè«‹æª¢æŸ¥ã€‚"); return; }
            if (allowableData.length === 0) { alert("å®¹è¨±å€¼æ•¸æ“šæ ¼å¼éŒ¯èª¤æˆ–ç„¡æœ‰æ•ˆè³‡æ–™ï¼Œè«‹æª¢æŸ¥ã€‚"); return; }

            // Safety Factor
            const sfInput = parseFloat(document.getElementById('safety-factor').value);
            if (isNaN(sfInput) || sfInput < 0) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å®‰å…¨ä¿‚æ•¸");
                return;
            }
            currentSF = sfInput;
            document.getElementById('sf-display').textContent = `(SF: ${currentSF})`;

            // Compare
            const results = [];
            
            analysisData.forEach(point => {
                const validPiles = [];
                allowableData.forEach(pile => {
                    const pCheck = 
                        pile.p.long >= (point.p.long * currentSF) &&
                        pile.p.short >= (point.p.short * currentSF) &&
                        pile.p.ult >= (point.p.ult * currentSF);
                    
                    const tCheck = 
                        (-1 * pile.t.long) <= (point.t.long * currentSF) &&
                        (-1 * pile.t.short) <= (point.t.short * currentSF) &&
                        (-1 * pile.t.ult) <= (point.t.ult * currentSF);

                    if (pCheck && tCheck) validPiles.push(pile);
                });
                results.push({ point, validPiles });
            });

            globalResults = results;
            renderTable(results);
            setupDownload(results);
            
            // Reset UI
            document.getElementById('ai-summary-content').innerHTML = '<p class="italic text-slate-400">é»æ“Šã€Œç”Ÿæˆå ±å‘Šã€æŒ‰éˆ•ï¼Œè®“ AI ç‚ºæ‚¨æ’°å¯«æœ¬æ¬¡åŸºæ¨é¸æ¨çš„å·¥ç¨‹ç¸½çµåˆ†æã€‚</p>';
            document.getElementById('result-section').classList.remove('hidden');
            document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });
        });

        function renderTable(results) {
            const tbody = document.getElementById('result-body');
            tbody.innerHTML = '';
            results.slice(0, 100).forEach((res, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors border-b last:border-0";
                const hasMatch = res.validPiles.length > 0;
                
                tr.innerHTML = `
                    <td class="px-4 py-3 font-mono font-bold text-blue-800">${res.point.id}</td>
                    <td class="px-4 py-3 text-xs text-slate-500 font-mono">
                        P: ${res.point.p.ult.toFixed(0)}<br>
                        T: ${res.point.t.ult.toFixed(0)}
                    </td>
                    <td class="px-4 py-3 text-sm text-slate-700">
                        ${hasMatch ? res.validPiles[0].fullDesc : '<span class="text-red-400 italic">ç„¡ç¬¦åˆæ¨å‹</span>'}
                    </td>
                    <td class="px-4 py-3 text-center font-bold ${hasMatch ? 'text-emerald-600' : 'text-red-500'}">
                        ${res.validPiles.length}
                    </td>
                    <td class="px-4 py-3 text-center">
                        ${hasMatch 
                            ? '<span class="px-2 py-1 text-xs rounded-full bg-emerald-100 text-emerald-800">åˆæ ¼</span>' 
                            : '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">å¤±æ•—</span>'}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="showDetail(${index})" class="text-indigo-600 hover:text-indigo-900 font-medium text-sm border border-indigo-200 px-3 py-1 rounded hover:bg-indigo-50">
                            è©³ç´°æ•¸æ“š
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showDetail(index) {
            currentDetailIndex = index;
            const data = globalResults[index];
            const point = data.point;
            const pile = data.validPiles.length > 0 ? data.validPiles[0] : null;

            document.getElementById('modal-title').innerText = `é»ä½ ${point.id} è©³ç´°æ¯”å° (SF=${currentSF})`;
            const content = document.getElementById('modal-content');
            
            let html = `
                <div class="mb-6 bg-gray-50 p-4 rounded border border-gray-200">
                    <h4 class="font-bold text-gray-700">æª¢æ ¸çµæœ: <span class="${pile ? 'text-green-600' : 'text-red-600'} text-lg">${pile ? 'âœ… åˆæ ¼' : 'âŒ å¤±æ•—'}</span></h4>
                    <p class="text-sm text-gray-600 mt-1">é¸å®šæ¨å‹: ${pile ? pile.fullDesc : 'ç„¡ç¬¦åˆ (é¡¯ç¤ºåŸå§‹å€¼ä¾›åƒè€ƒ)'}</p>
                </div>
            `;

            html += `
                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200 text-sm text-center">
                        <thead class="bg-gray-100 text-gray-700">
                            <tr>
                                <th class="px-4 py-3 text-left">æª¢æŸ¥é …ç›®</th>
                                <th class="px-4 py-3">åŸå§‹åˆ†æå€¼</th>
                                <th class="px-4 py-3 text-indigo-700 font-bold bg-indigo-50 border-x border-indigo-100">æª¢æ ¸éœ€æ±‚å€¼<br><span class="text-xs font-normal">(åˆ†æå€¼ Ã— ${currentSF})</span></th>
                                <th class="px-4 py-3">æ¨å‹å®¹è¨±å€¼</th>
                                <th class="px-4 py-3">åˆ¤å®š</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 bg-white">
            `;

            const rows = [
                { name: "æ‰¿å£“åŠ› P (é•·æœŸ)", ana: point.p.long,  pile: pile ? pile.p.long : null,  type: 'P' },
                { name: "æ‰¿å£“åŠ› P (çŸ­æœŸ)", ana: point.p.short, pile: pile ? pile.p.short : null, type: 'P' },
                { name: "æ‰¿å£“åŠ› P (æ¥µé™)", ana: point.p.ult,   pile: pile ? pile.p.ult : null,   type: 'P' },
                { name: "æ‹‰æ‹”åŠ› T (é•·æœŸ)", ana: point.t.long,  pile: pile ? pile.t.long : null,  type: 'T' },
                { name: "æ‹‰æ‹”åŠ› T (çŸ­æœŸ)", ana: point.t.short, pile: pile ? pile.t.short : null, type: 'T' },
                { name: "æ‹‰æ‹”åŠ› T (æ¥µé™)", ana: point.t.ult,   pile: pile ? pile.t.ult : null,   type: 'T' },
            ];

            rows.forEach(row => {
                let statusHtml = "";
                let reqValDisplay = "";
                let pileValDisplay = "-";
                let reqVal = row.ana * currentSF;

                if (pile) {
                    if (row.type === 'P') {
                        let pass = row.pile >= reqVal;
                        statusHtml = pass ? '<span class="text-green-600 font-bold">âœ“ åˆæ ¼</span>' : '<span class="text-red-600 font-bold">âœ— å¤±æ•—</span>';
                        pileValDisplay = `<span class="font-mono text-blue-600">${row.pile.toFixed(2)}</span>`;
                        reqValDisplay = `<span class="font-mono text-indigo-700 font-bold">${reqVal.toFixed(2)}</span>`;
                    } else {
                        let pileNeg = -1 * row.pile;
                        let pass = pileNeg <= reqVal;
                        statusHtml = pass ? '<span class="text-green-600 font-bold">âœ“ åˆæ ¼</span>' : '<span class="text-red-600 font-bold">âœ— å¤±æ•—</span>';
                        pileValDisplay = `<span class="font-mono text-blue-600">${pileNeg.toFixed(2)}</span>`;
                        reqValDisplay = `<span class="font-mono text-indigo-700 font-bold">${reqVal.toFixed(2)}</span>`;
                    }
                } else {
                    statusHtml = '<span class="text-gray-400">-</span>';
                    reqValDisplay = reqVal.toFixed(2);
                }

                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-left font-medium text-gray-800">${row.name}</td>
                        <td class="px-4 py-3 font-mono text-gray-500">${row.ana.toFixed(2)}</td>
                        <td class="px-4 py-3 font-mono bg-indigo-50 border-x border-indigo-100 text-indigo-800 font-semibold">${reqValDisplay}</td>
                        <td class="px-4 py-3">${pileValDisplay}</td>
                        <td class="px-4 py-3">${statusHtml}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            if (!pile) html += `<div class="mt-4 p-3 bg-red-50 text-red-700 text-sm rounded">æ­¤é»ä½åœ¨åŠ å…¥å®‰å…¨ä¿‚æ•¸ ${currentSF} å¾Œï¼Œç„¡æ³•æ‰¾åˆ°ç¬¦åˆçš„æ¨å‹ã€‚</div>`;

            content.innerHTML = html;

            document.getElementById('ai-insight-block').classList.remove('hidden');
            document.getElementById('ai-detail-result').innerHTML = '<p class="text-slate-400 italic">é»æ“ŠæŒ‰éˆ•ï¼Œè®“ AI åˆ†ææ­¤æ¨ä½çš„æ‡‰åŠ›æ¯”èˆ‡æ§åˆ¶å› å­ã€‚</p>';
            
            const btnDetail = document.getElementById('btn-ai-detail');
            if (pile) {
                btnDetail.disabled = false;
                btnDetail.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btnDetail.disabled = true;
                btnDetail.classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('ai-detail-result').innerHTML = '<p class="text-red-400 italic">ç„¡é¸å®šæ¨å‹ï¼Œç„¡æ³•é€²è¡Œè©³ç´° AI åˆ†æã€‚</p>';
            }

            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('detail-modal').classList.add('flex');
            document.body.classList.add('modal-open');
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
            document.getElementById('detail-modal').classList.remove('flex');
            document.body.classList.remove('modal-open');
        }

        // --- License Modal Functions ---
        function showLicense() {
            const modal = document.getElementById('license-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        function closeLicense() {
            const modal = document.getElementById('license-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // --- AI Features ---
        document.getElementById('btn-ai-summary').addEventListener('click', async () => {
            const btn = document.getElementById('btn-ai-summary');
            const contentDiv = document.getElementById('ai-summary-content');

            if (!globalResults) return;

            const total = globalResults.length;
            const passed = globalResults.filter(r => r.validPiles.length > 0).length;
            const failed = total - passed;
            
            const pileCounts = {};
            globalResults.forEach(r => {
                if(r.validPiles.length > 0) {
                    const name = r.validPiles[0].shortName;
                    pileCounts[name] = (pileCounts[name] || 0) + 1;
                }
            });
            let commonPile = "ç„¡";
            let maxCount = 0;
            for(const [name, count] of Object.entries(pileCounts)){
                if(count > maxCount) { maxCount = count; commonPile = name; }
            }

            const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„åœŸæœ¨å¤§åœ°å·¥ç¨‹å¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹ã€ŒåŸºæ¨é¸æ¨åˆ†æçµæœã€æ’°å¯«ä¸€æ®µç¹é«”ä¸­æ–‡çš„å·¥ç¨‹ç¸½çµå ±å‘Š (Executive Summary)ã€‚
                
                æ•¸æ“šå¦‚ä¸‹ï¼š
                - åˆ†æé»ä½ç¸½æ•¸ï¼š${total}
                - åˆæ ¼é»ä½æ•¸ï¼š${passed}
                - å¤±æ•—é»ä½æ•¸ï¼š${failed}
                - è¨­å®šä¹‹å®‰å…¨ä¿‚æ•¸ (SF)ï¼š${currentSF}
                - æœ€å¸¸è¢«é¸ç”¨çš„å»ºè­°æ¨å‹ï¼š${commonPile}

                æ’°å¯«è¦æ±‚ï¼š
                1. èªæ°£å°ˆæ¥­ã€å®¢è§€ã€‚
                2. ç¸½çµæ•´é«”çš„åˆæ ¼ç‡æƒ…æ³ã€‚
                3. æåŠå®‰å…¨ä¿‚æ•¸çš„è¨­å®šå°çµæœçš„å½±éŸ¿ã€‚
                4. é‡å°æœ€å¸¸é¸ç”¨çš„æ¨å‹åšç°¡å–®æè¿°ã€‚
            `;

            btn.disabled = true;
            btn.innerHTML = '<div class="sparkle-loading mr-2"></div> ç”Ÿæˆä¸­...';
            contentDiv.innerHTML = '<div class="animate-pulse flex space-x-4"><div class="flex-1 space-y-4 py-1"><div class="h-4 bg-slate-200 rounded w-3/4"></div><div class="h-4 bg-slate-200 rounded"></div></div></div>';

            const resultText = await callGemini(prompt);

            btn.disabled = false;
            btn.innerHTML = '<span class="mr-1">âœ¨</span> é‡æ–°ç”Ÿæˆ';
            
            if (resultText) contentDiv.innerHTML = marked.parse(resultText);
            else contentDiv.innerHTML = '<p class="text-red-500">ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Keyã€‚</p>';
        });

        document.getElementById('btn-ai-detail').addEventListener('click', async () => {
            const btn = document.getElementById('btn-ai-detail');
            const resultDiv = document.getElementById('ai-detail-result');

            if (currentDetailIndex === -1 || !globalResults[currentDetailIndex]) return;

            const data = globalResults[currentDetailIndex];
            const p = data.point;
            const pile = data.validPiles[0];
            
            const reqP = p.p.ult * currentSF;
            const ratioP = (reqP / pile.p.ult).toFixed(2);
            
            const reqT = p.t.ult * currentSF; 
            const pileT = -1 * pile.t.ult; 
            const ratioT = (Math.abs(reqT) / Math.abs(pileT)).toFixed(2);

            const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„åœŸæœ¨å·¥ç¨‹å¸«ã€‚è«‹é‡å°é€™ä¸€å€‹åŸºæ¨é»ä½ (ID: ${p.id}) çš„é¸æ¨çµæœé€²è¡Œç°¡çŸ­çš„æ‡‰åŠ›åˆ†æã€‚

                æ•¸æ“šç’°å¢ƒï¼š
                - å®‰å…¨ä¿‚æ•¸ (SF): ${currentSF}
                
                æ¥µé™æ‰¿å£“åŠ› (Compression):
                - éœ€æ±‚å€¼ (å«SF): ${reqP.toFixed(1)}
                - æ¨å®¹è¨±å€¼: ${pile.p.ult.toFixed(1)}
                - æ‡‰åŠ›æ¯” (D/C Ratio): ${ratioP}

                æ¥µé™æ‹‰æ‹”åŠ› (Tension):
                - éœ€æ±‚å€¼ (å«SF): ${reqT.toFixed(1)} (è² å€¼ä»£è¡¨æ‹‰åŠ›)
                - æ¨å®¹è¨±å€¼: ${pileT.toFixed(1)} (è² å€¼ä»£è¡¨æ‹‰åŠ›)
                - æ‡‰åŠ›æ¯” (D/C Ratio): ${ratioT}

                è«‹åˆ†æï¼š
                1. å“ªä¸€å€‹åŠ›é‡ (æ‰¿å£“æˆ–æ‹‰æ‹”) æ˜¯æ­¤æ¨çš„æ§åˆ¶å› å­ï¼Ÿ
                2. å®‰å…¨é¤˜è£• (Margin) æ˜¯å¦å……è¶³ï¼Ÿ
                3. çµ¦å‡ºä¸€å¥ç°¡çŸ­çš„å·¥ç¨‹è©•èªã€‚
            `;

            btn.disabled = true;
            btn.textContent = 'åˆ†æä¸­...';
            resultDiv.innerHTML = '<div class="animate-pulse h-4 bg-indigo-200 rounded w-3/4"></div>';

            const resultText = await callGemini(prompt);

            btn.disabled = false;
            btn.textContent = 'é‡æ–°åˆ†æ';

            if (resultText) resultDiv.innerHTML = marked.parse(resultText);
            else resultDiv.innerHTML = '<p class="text-red-500">åˆ†æå¤±æ•—ã€‚</p>';
        });

        function setupDownload(results) {
            const btn = document.getElementById('btn-download');
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);

            newBtn.addEventListener('click', () => {
                let csv = "\uFEFF"; 
                csv += `å®‰å…¨ä¿‚æ•¸è¨­å®š: ${currentSF}\n`;
                csv += "é»ä½ID,åˆ†æP_é•·æœŸ,åˆ†æP_çŸ­æœŸ,åˆ†æP_æ¥µé™,åˆ†æT_é•·æœŸ,åˆ†æT_çŸ­æœŸ,åˆ†æT_æ¥µé™,éœ€æ±‚P_é•·æœŸ,éœ€æ±‚P_çŸ­æœŸ,éœ€æ±‚P_æ¥µé™,éœ€æ±‚T_é•·æœŸ,éœ€æ±‚T_çŸ­æœŸ,éœ€æ±‚T_æ¥µé™,åˆ¤å®šçµæœ,ç¬¦åˆæ¨å‹æ•¸,é¸å®šæ¨å‹è¦æ ¼,æ¨å®¹è¨±P_é•·æœŸ,æ¨å®¹è¨±P_çŸ­æœŸ,æ¨å®¹è¨±P_æ¥µé™,æ¨å®¹è¨±T_é•·æœŸ(è½‰è² ),æ¨å®¹è¨±T_çŸ­æœŸ(è½‰è² ),æ¨å®¹è¨±T_æ¥µé™(è½‰è² ),æ‰€æœ‰ç¬¦åˆæ¨å‹æ¸…å–®\n";

                results.forEach(res => {
                    const p = res.point;
                    const pile = res.validPiles.length > 0 ? res.validPiles[0] : null;
                    const status = pile ? "åˆæ ¼" : "ä¸åˆæ ¼";
                    const count = res.validPiles.length;
                    const safeName = pile ? `"${pile.fullDesc.replace(/"/g, '""')}"` : "";
                    const safeAll = `"${res.validPiles.map(x=>x.fullDesc).join('; ').replace(/"/g, '""')}"`;

                    let row = `${p.id},${p.p.long},${p.p.short},${p.p.ult},${p.t.long},${p.t.short},${p.t.ult},`;
                    row += `${(p.p.long*currentSF).toFixed(2)},${(p.p.short*currentSF).toFixed(2)},${(p.p.ult*currentSF).toFixed(2)},`;
                    row += `${(p.t.long*currentSF).toFixed(2)},${(p.t.short*currentSF).toFixed(2)},${(p.t.ult*currentSF).toFixed(2)},`;
                    row += `${status},${count},${safeName},`;
                    
                    if (pile) {
                        row += `${pile.p.long},${pile.p.short},${pile.p.ult},`;
                        row += `${-1*pile.t.long},${-1*pile.t.short},${-1*pile.t.ult},`;
                    } else {
                        row += ",,,,,,"; 
                    }
                    row += safeAll;
                    csv += row + "\n";
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `åŸºæ¨é¸æ¨å ±å‘Š_SF${currentSF}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }
    </script>
</body>
</html>



